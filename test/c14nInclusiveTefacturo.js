const c14n = require("../lib/exclusive-canonicalization").ExclusiveCanonicalization,
  Dom = require('xmldom').DOMParser,
  select = require('xpath.js'),
  SignedXml = require('../lib/signed-xml.js').SignedXml
const compare = function (test, xml, xpath, expected, inclusiveNamespacesPrefixList) {
  test.expect(1)
  const doc = new Dom().parseFromString(xml),
    elem = select(doc, xpath)[0],
    can = new c14n(),
    result = can.process(elem, { isC14n: true, inclusiveNamespacesPrefixList: inclusiveNamespacesPrefixList }).toString()

  test.equal(expected, result)
  test.done()
}
module.exports = {
  "Inclusive canonicalization works": (test) => {
    compare(test,
      '<ns0:CFE xmlns:ns0="http://cfe.dgi.gub.uy" version="1.0"><ns0:eResg><ns0:TmstFirma>2017-03-20T11:08:38-03:00</ns0:TmstFirma><ns0:Encabezado><ns0:IdDoc><ns0:TipoCFE>182</ns0:TipoCFE><ns0:Serie>A</ns0:Serie><ns0:Nro>1</ns0:Nro><ns0:FchEmis>2017-03-20</ns0:FchEmis></ns0:IdDoc><ns0:Emisor><ns0:RUCEmisor>219999830019</ns0:RUCEmisor><ns0:RznSoc>DGI</ns0:RznSoc><ns0:CdgDGISucur>1</ns0:CdgDGISucur><ns0:DomFiscal>FERNANDEZ CRESPO AVDA. DANIEL 1534</ns0:DomFiscal><ns0:Ciudad>MONTEVIDEO</ns0:Ciudad><ns0:Departamento>MONTEVIDEO</ns0:Departamento></ns0:Emisor><ns0:Receptor><ns0:TipoDocRecep>2</ns0:TipoDocRecep><ns0:CodPaisRecep>UY</ns0:CodPaisRecep><ns0:DocRecep>180287610017</ns0:DocRecep><ns0:RznSocRecep>DURAND GUASTAVINO ELISA BEATRIZ Y ESTEVES MIGONE ALFREDO JOSE</ns0:RznSocRecep><ns0:DirRecep>18 DE JULIO</ns0:DirRecep><ns0:CiudadRecep>PALMITAS</ns0:CiudadRecep></ns0:Receptor><ns0:Totales><ns0:TpoMoneda>UYU</ns0:TpoMoneda><ns0:MntTotRetenido>55000</ns0:MntTotRetenido><ns0:CantLinDet>2</ns0:CantLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:ValRetPerc>55000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Totales></ns0:Encabezado><ns0:Detalle><ns0:Item><ns0:NroLinDet>1</ns0:NroLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:Tasa>50</ns0:Tasa><ns0:MntSujetoaRet>22000</ns0:MntSujetoaRet><ns0:ValRetPerc>11000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Item><ns0:Item><ns0:NroLinDet>2</ns0:NroLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:Tasa>50</ns0:Tasa><ns0:MntSujetoaRet>88000</ns0:MntSujetoaRet><ns0:ValRetPerc>44000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Item></ns0:Detalle><ns0:Referencia><ns0:Referencia xmlns="http://cfe.dgi.gub.uy"><ns0:NroLinRef>1</ns0:NroLinRef><ns0:TpoDocRef>111</ns0:TpoDocRef><ns0:Serie>A</ns0:Serie><ns0:NroCFERef>25</ns0:NroCFERef><ns0:FechaCFEref>2017-03-20</ns0:FechaCFEref></ns0:Referencia><ns0:Referencia xmlns="http://cfe.dgi.gub.uy"><ns0:NroLinRef>2</ns0:NroLinRef><ns0:TpoDocRef>111</ns0:TpoDocRef><ns0:Serie>A</ns0:Serie><ns0:NroCFERef>30</ns0:NroCFERef><ns0:FechaCFEref>2017-03-20</ns0:FechaCFEref></ns0:Referencia></ns0:Referencia><ns0:CAEData><ns0:CAE_ID>90110002917</ns0:CAE_ID><ns0:DNro>1</ns0:DNro><ns0:HNro>100</ns0:HNro><ns0:FecVenc>2017-12-31</ns0:FecVenc></ns0:CAEData></ns0:eResg></ns0:CFE>',
      "//*",
      '<ns0:CFE xmlns:ns0="http://cfe.dgi.gub.uy" version="1.0"><ns0:eResg><ns0:TmstFirma>2017-03-20T11:08:38-03:00</ns0:TmstFirma><ns0:Encabezado><ns0:IdDoc><ns0:TipoCFE>182</ns0:TipoCFE><ns0:Serie>A</ns0:Serie><ns0:Nro>1</ns0:Nro><ns0:FchEmis>2017-03-20</ns0:FchEmis></ns0:IdDoc><ns0:Emisor><ns0:RUCEmisor>219999830019</ns0:RUCEmisor><ns0:RznSoc>DGI</ns0:RznSoc><ns0:CdgDGISucur>1</ns0:CdgDGISucur><ns0:DomFiscal>FERNANDEZ CRESPO AVDA. DANIEL 1534</ns0:DomFiscal><ns0:Ciudad>MONTEVIDEO</ns0:Ciudad><ns0:Departamento>MONTEVIDEO</ns0:Departamento></ns0:Emisor><ns0:Receptor><ns0:TipoDocRecep>2</ns0:TipoDocRecep><ns0:CodPaisRecep>UY</ns0:CodPaisRecep><ns0:DocRecep>180287610017</ns0:DocRecep><ns0:RznSocRecep>DURAND GUASTAVINO ELISA BEATRIZ Y ESTEVES MIGONE ALFREDO JOSE</ns0:RznSocRecep><ns0:DirRecep>18 DE JULIO</ns0:DirRecep><ns0:CiudadRecep>PALMITAS</ns0:CiudadRecep></ns0:Receptor><ns0:Totales><ns0:TpoMoneda>UYU</ns0:TpoMoneda><ns0:MntTotRetenido>55000</ns0:MntTotRetenido><ns0:CantLinDet>2</ns0:CantLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:ValRetPerc>55000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Totales></ns0:Encabezado><ns0:Detalle><ns0:Item><ns0:NroLinDet>1</ns0:NroLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:Tasa>50</ns0:Tasa><ns0:MntSujetoaRet>22000</ns0:MntSujetoaRet><ns0:ValRetPerc>11000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Item><ns0:Item><ns0:NroLinDet>2</ns0:NroLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:Tasa>50</ns0:Tasa><ns0:MntSujetoaRet>88000</ns0:MntSujetoaRet><ns0:ValRetPerc>44000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Item></ns0:Detalle><ns0:Referencia><ns0:Referencia xmlns="http://cfe.dgi.gub.uy"><ns0:NroLinRef>1</ns0:NroLinRef><ns0:TpoDocRef>111</ns0:TpoDocRef><ns0:Serie>A</ns0:Serie><ns0:NroCFERef>25</ns0:NroCFERef><ns0:FechaCFEref>2017-03-20</ns0:FechaCFEref></ns0:Referencia><ns0:Referencia xmlns="http://cfe.dgi.gub.uy"><ns0:NroLinRef>2</ns0:NroLinRef><ns0:TpoDocRef>111</ns0:TpoDocRef><ns0:Serie>A</ns0:Serie><ns0:NroCFERef>30</ns0:NroCFERef><ns0:FechaCFEref>2017-03-20</ns0:FechaCFEref></ns0:Referencia></ns0:Referencia><ns0:CAEData><ns0:CAE_ID>90110002917</ns0:CAE_ID><ns0:DNro>1</ns0:DNro><ns0:HNro>100</ns0:HNro><ns0:FecVenc>2017-12-31</ns0:FecVenc></ns0:CAEData></ns0:eResg></ns0:CFE>')
  },
  "set de prueba DGI tefacturouy": (test) => {
    let sig = new SignedXml('wssecurity', { inclusiveNamespacesPrefixList: ['DGICFE', 'xd'] })
    sig.keyInfoProvider = {
      getKey: () => {
        return `-----BEGIN CERTIFICATE-----\nMIIGTTCCBDWgAwIBAgIUASiXhcxq988QWlvwLWoSspqab5EwDQYJKoZIhvcNAQEL\nBQAwWjEdMBsGA1UEAxMUQ29ycmVvIFVydWd1YXlvIC0gQ0ExLDAqBgNVBAoMI0Fk\nbWluaXN0cmFjacOzbiBOYWNpb25hbCBkZSBDb3JyZW9zMQswCQYDVQQGEwJVWTAe\nFw0xNzAxMjQxODQ1MDRaFw0xOTAxMjQxODQ1MDRaMHkxGDAWBgNVBAUTD1JVQzIx\nOTk5OTgzMDAxOTELMAkGA1UEBhMCVVkxJzAlBgNVBAoTHioqKlRFU1QqKiogREdJ\nLVJVQyBQUlVFQkEgQ0VERTEnMCUGA1UEAxMeKioqVEVTVCoqKiBER0ktUlVDIFBS\nVUVCQSBDRURFMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAyanlLbHL\nvcyHUVzwOhfapTgBgTaLCqxkeGx+4n9D00RICYzYEl8f8wDlVsHj9XNdl37vDHD0\n0FAdFqeCs70jZJn09+n0GlU3uol27+QsrHhBWOzcu/wq2W1lP7jW1VRyJUyJLcjE\n/tIGkMxzquXWbA2zPNNoAL/W2nh5tlBY8qR1/YliikXIcfviTTj/IOoFndnXzKbX\nlDOd/6Ce1rxIw7e2ssvEjVT9I+GCoR/qj6Z8dHLh+2/c7KVwpUU873ZWyS84Lm//\nzTI8gpQ0Q5d+o6FEyOLAGX0KrD8iOY6XssaSRxHZPkxd5AgqCgRL1dmNUW7B5DL+\nZiViR53smtiKTQIDAQABo4IB6jCCAeYweQYIKwYBBQUHAQEEbTBrMDYGCCsGAQUF\nBzAChipodHRwOi8vYW5jY2EuY29ycmVvLmNvbS51eS9hbmNjYS9hbmNjYS5jZXIw\nMQYIKwYBBQUHMAGGJWh0dHA6Ly9hbmNjYS5jb3JyZW8uY29tLnV5L2FuY2NhL09D\nU1AwDgYDVR0PAQH/BAQDAgTwMAwGA1UdEwEB/wQCMAAwOwYDVR0fBDQwMjAwoC6g\nLIYqaHR0cDovL2FuY2NhLmNvcnJlby5jb20udXkvYW5jY2EvYW5jY2EuY3JsMIG4\nBgNVHSAEgbAwga0wZAYLYIZahOKuHYSIBQQwVTBTBggrBgEFBQcCARZHaHR0cDov\nL3VjZS5ndWIudXkvaW5mb3JtYWNpb24tdGVjbmljYS9wb2xpdGljYXMvY3BfcGVy\nc29uYV9qdXJpZGljYS5wZGYwRQYLYIZahOKuHYSIBQYwNjA0BggrBgEFBQcCARYo\naHR0cDovL2FuY2NhLmNvcnJlby5jb20udXkvYW5jY2EvY3BzLnBkZjATBgNVHSUE\nDDAKBggrBgEFBQcDAjAdBgNVHQ4EFgQULRm7spPDBgqrNFTM9q/z1yAK92swHwYD\nVR0jBBgwFoAUbOKwJo1b1iYIH5hdaeAOf1XsrnYwDQYJKoZIhvcNAQELBQADggIB\nACk60iSv+i30OfCWRYIN/XMfh3cjYOWSglDoR6+EjrxktXQrzgjfwjhVZ4tI9E1L\ni5XPOjcv/A2C4SAli3zE4LzqBKvDess9DJ6PJee7mdsgVRrJu6/DS0iw/K8EJvTl\nWq285U7SiEHb74sfSCVu93wwGkbZ7iYrR1BcArQ2l3yGq9RsCtCqfNhTrAM+VDwe\nGjNfnC5Alpeo0LhcS5EV2l5+XWB864/l3yV/+TNu7jB+MB6gx/7f3mSKSmLlNFBR\nxt0iCOcyWQUvnrri/RbrVdRjphRyjqrmMW99jJp3RmdIk5GdNZ051zckhe1z4s/l\n1ScaaYIroA9dl06VZrJIXNkG1uotYbfFCOMGRN74hV9gkcDDOoXl9sAcZQd/UxKs\nZl9nbjr0WHQFEMGeyq/eJxiFyrEGeXWaf/kFub50eMQQjR04t2fAHvIiPHMq3Hoo\nNiORe2uO7Rx1PacajRXrXnMJGHef85cTfUwFcHctnWfb1wuzW4Z0QPucgfT0/m12\nUzr/RWLKBF98ZpT7snDgdwnvV0BtwAG9Lkc/T9ccDxdqyiXysjsgv8ehZHvjJXth\n7K5pwS543kIj6N1hMyvqdu22stCTej5Jlup845HH5vBMD88gQO92A6VNX58XaLKD\nRX28vpCj6ffLb9c14vSmLUsO3rg8edDFdAfMfJDFd4uJ\n-----END CERTIFICATE-----`
      }

    }
    sig.loadSignature(`<Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
<SignedInfo>
  <CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
  <SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
  <Reference URI="">
    <Transforms>
      <Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
      <Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
    </Transforms>
    <DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
    <DigestValue>GVxE8+8BT5BUI0pHJYURMaJohG4=</DigestValue>
  </Reference>
</SignedInfo>
    <SignatureValue>oAgaQqqYKpyJ+M/zKaSQj0RCTGea4bscx6fhj9D1ZdUNfBF9VXCZdwvApRjMaE89p44eenVkuJdKNqQWxYI+z8iVGa0O14NdiqGB5RvAasvj2XNsflue3SqBk0PSmKAbOPgQcc2wFmIdWtUTbUlQeYJNkpIS0r1yA1yNfIIY4HbxVqv9O8WV7MDUE1f7yho6QgwxBZVnlHRa6JbwHXAX+kPuOBgwK9GC3IOqaiHwzYVJL2kSZZSwIDx8usvBERQYpUKB5iQI75BdX9sNkMlm6Jj2G8kj2xWgYl5TWB8K0UuF1N8CzGo8JtVNtIiOhMJqv81v2Se0AAsmEqdxTqf/RA==</SignatureValue><KeyInfo><X509Data><X509IssuerSerial><X509IssuerName>C=UY, O="Administraci\C3\B3n Nacional de Correos", CN=Correo Uruguayo - CA</X509IssuerName><X509SerialNumber>6614220063213481499544123309412860796549623697</X509SerialNumber></X509IssuerSerial></X509Data></KeyInfo></Signature>`)

    let sigIsValid = sig.checkSignature(`<ns0:CFE xmlns:ns0="http://cfe.dgi.gub.uy" version="1.0"><ns0:eResg><ns0:TmstFirma>2017-03-20T11:08:38-03:00</ns0:TmstFirma><ns0:Encabezado><ns0:IdDoc><ns0:TipoCFE>182</ns0:TipoCFE><ns0:Serie>A</ns0:Serie><ns0:Nro>1</ns0:Nro><ns0:FchEmis>2017-03-20</ns0:FchEmis></ns0:IdDoc><ns0:Emisor><ns0:RUCEmisor>219999830019</ns0:RUCEmisor><ns0:RznSoc>DGI</ns0:RznSoc><ns0:CdgDGISucur>1</ns0:CdgDGISucur><ns0:DomFiscal>FERNANDEZ CRESPO AVDA. DANIEL 1534</ns0:DomFiscal><ns0:Ciudad>MONTEVIDEO</ns0:Ciudad><ns0:Departamento>MONTEVIDEO</ns0:Departamento></ns0:Emisor><ns0:Receptor><ns0:TipoDocRecep>2</ns0:TipoDocRecep><ns0:CodPaisRecep>UY</ns0:CodPaisRecep><ns0:DocRecep>180287610017</ns0:DocRecep><ns0:RznSocRecep>DURAND GUASTAVINO ELISA BEATRIZ Y ESTEVES MIGONE ALFREDO JOSE</ns0:RznSocRecep><ns0:DirRecep>18 DE JULIO</ns0:DirRecep><ns0:CiudadRecep>PALMITAS</ns0:CiudadRecep></ns0:Receptor><ns0:Totales><ns0:TpoMoneda>UYU</ns0:TpoMoneda><ns0:MntTotRetenido>55000</ns0:MntTotRetenido><ns0:CantLinDet>2</ns0:CantLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:ValRetPerc>55000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Totales></ns0:Encabezado><ns0:Detalle><ns0:Item><ns0:NroLinDet>1</ns0:NroLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:Tasa>50</ns0:Tasa><ns0:MntSujetoaRet>22000</ns0:MntSujetoaRet><ns0:ValRetPerc>11000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Item><ns0:Item><ns0:NroLinDet>2</ns0:NroLinDet><ns0:RetencPercep><ns0:CodRet>2183165</ns0:CodRet><ns0:Tasa>50</ns0:Tasa><ns0:MntSujetoaRet>88000</ns0:MntSujetoaRet><ns0:ValRetPerc>44000</ns0:ValRetPerc></ns0:RetencPercep></ns0:Item></ns0:Detalle><ns0:Referencia><ns0:Referencia xmlns="http://cfe.dgi.gub.uy"><ns0:NroLinRef>1</ns0:NroLinRef><ns0:TpoDocRef>111</ns0:TpoDocRef><ns0:Serie>A</ns0:Serie><ns0:NroCFERef>25</ns0:NroCFERef><ns0:FechaCFEref>2017-03-20</ns0:FechaCFEref></ns0:Referencia><ns0:Referencia xmlns="http://cfe.dgi.gub.uy"><ns0:NroLinRef>2</ns0:NroLinRef><ns0:TpoDocRef>111</ns0:TpoDocRef><ns0:Serie>A</ns0:Serie><ns0:NroCFERef>30</ns0:NroCFERef><ns0:FechaCFEref>2017-03-20</ns0:FechaCFEref></ns0:Referencia></ns0:Referencia><ns0:CAEData><ns0:CAE_ID>90110002917</ns0:CAE_ID><ns0:DNro>1</ns0:DNro><ns0:HNro>100</ns0:HNro><ns0:FecVenc>2017-12-31</ns0:FecVenc></ns0:CAEData></ns0:eResg><Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
<SignedInfo>
  <CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
  <SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
  <Reference URI="">
    <Transforms>
      <Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
      <Transform Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>
    </Transforms>
    <DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
    <DigestValue>GVxE8+8BT5BUI0pHJYURMaJohG4=</DigestValue>
  </Reference>
</SignedInfo>
    <SignatureValue>oAgaQqqYKpyJ+M/zKaSQj0RCTGea4bscx6fhj9D1ZdUNfBF9VXCZdwvApRjMaE89p44eenVkuJdKNqQWxYI+z8iVGa0O14NdiqGB5RvAasvj2XNsflue3SqBk0PSmKAbOPgQcc2wFmIdWtUTbUlQeYJNkpIS0r1yA1yNfIIY4HbxVqv9O8WV7MDUE1f7yho6QgwxBZVnlHRa6JbwHXAX+kPuOBgwK9GC3IOqaiHwzYVJL2kSZZSwIDx8usvBERQYpUKB5iQI75BdX9sNkMlm6Jj2G8kj2xWgYl5TWB8K0UuF1N8CzGo8JtVNtIiOhMJqv81v2Se0AAsmEqdxTqf/RA==</SignatureValue><KeyInfo><X509Data><X509IssuerSerial><X509IssuerName>C=UY, O="Administraci\C3\B3n Nacional de Correos", CN=Correo Uruguayo - CA</X509IssuerName><X509SerialNumber>6614220063213481499544123309412860796549623697</X509SerialNumber></X509IssuerSerial></X509Data></KeyInfo></Signature></ns0:CFE>`)
    console.log(sig.validationErrors)
    test.ok(sigIsValid)
    test.done()
  },
}